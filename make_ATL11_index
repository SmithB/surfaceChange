#! /usr/bin/env bash 


env_str='source activate ATL14;'
#prog='/home/besmith4/git_repos/pointCollection/pointCollection/index_glob.py'
prog='index_glob.py'
#env_str=''

ATL14_dir=$1
ATL11_dir=$2 

# make links
[ -d $ATL14_dir/ATL11 ]  || mkdir $ATL14_dir/ATL11
[ -L $ATL14_dir/global ] || ln -s $ATL11_dir $ATL14_dir/global

for hemi in north south; do
    echo $hemi
    if [ hemi = 'north' ]; then
	hemisphere=1
	the_digit=0
    else
	hemisphere=-1
	the_digit=1
    fi

    hemi_dir=$ATL14_dir/$hemi
    ATL11_sub=$hemi_dir/ATL11
    index_dir=$ATL11_sub/index
    [ -f $index_dir/GeoIndex.h5 ] && continue

    [ -d $hemi_dir ] || mkdir $hemi_dir
    [ -d $ATL11_sub ] || mkdir $ATL11_sub
    [ -d $index_dir ] || mkdir $index_dir 
    echo $hemi $hemisphere $hemi_dir $index_dir
    
    > index_queue.txt
    for file in `ls $ATL11_dir/ATL11_????$the_digit?_????_???_??.h5`; do
	base=`basename $file`
	[ -L $AT11_sub/$base ] || ln -s $file $ATL11_sub
	
	index_file=$index_dir"/"$base
	[ -f $index_file ] && continue
	echo "$env_str pushd $index_dir; $prog  --hemisphere $hemisphere --type ATL11 -g ../$base --index_file $index_file --Relative" >> index_queue.txt    
    done

#    pboss.py -s index_queue.txt -j 8 -r -w

#    source activate IS2
#    pushd $index_dir; $prog --hemisphere $hemisphere --type h5_geoindex -g "ATL11*.h5" --index_file GeoIndex.h5 --Relative
#    popd
#    conda deactivate
done
#source activate ATL14; python3 $prog --type h5_geoindex -g "$thedir/index/ATL11*.h5" --index_file $thedir/index/GeoIndex.h5 --dir_root $thedir/index/ --hemisphere $hemisphere

